# Задание 1 — найди ошибки

В этом репозитории находятся материалы тестового задания "Найди ошибки" для [14-й Школы разработки интерфейсов](https://academy.yandex.ru/events/frontend/shri_msk-2018-2) (осень 2018, Москва, Санкт-Петербург, Симферополь).

Для работы тестового приложения нужен Node.JS v9. В проекте используются [Yandex Maps API](https://tech.yandex.ru/maps/doc/jsapi/2.1/quick-start/index-docpage/) и [ChartJS](http://www.chartjs.org).

## Задание

Код содержит ошибки разной степени критичности. Некоторые из них — стилистические, а другие — даже не позволят вам запустить приложение. Вам нужно найти все ошибки и исправить их.

Пункты для самопроверки:

1. Приложение должно успешно запускаться.
1. По адресу http://localhost:9000 должна открываться карта с метками.
1. Должна правильно работать вся функциональность, перечисленная в условиях задания.
1. Не должно быть лишнего кода.
1. Все должно быть в едином codestyle.

## Запуск

```
npm i
npm start
```

При каждом запуске тестовые данные генерируются заново случайным образом.


## Ход работы

1. При попытке запустить приложение появляется предупреждение о том, что в файле map.js нет
дефолтного экспорта. Также показывается в каком месте происходит импорт из этого файла. Заглядываем в index.js, где наблюдаем попытку импортнуть тот самый дефолтный экспорт, которого нет. Добавляем default в экспорт функции initMap в файле map.js.

2. Больше ошибок на этапе сборки не показывается, поэтому пробуем зайти в само приложение. Видим, что нас встречает белый экран, при этом никаких ошибок в консоли нет. В журнале написано "inited", что значит, что импортнутая функция initMap теоретически работает нормально, но что-то пошло не так. Проверив в инспекторе контейнер #map, видим, что высота у карты захардкожена на 0. В файле public/style.css ставлю контейнеру #map высоту 100vh, чтобы карта занимала всё пространство на экране. Теперь карта видна.

3. Карта просто показывает город, и на ней ничего помимо этого нет. Однако вижу, как инициилизурется ObjectManager, куда загружаются данные с сервера, но никаких связей с самой картой у него нет. Может, это происходит под капотом? Зачем гадать, сли можно почитать документацию самих карт. Открываю пункт про ObjectManager и вижу, что его нужно добавлять к карте через geoObjects. Сделав это, видим, что в Москве по-прежнему пусто. Спустя некоторое время недоумевания, анзумим карту и видим, что все объекты оказывается находятся совсем в другом месте.

4. Пытаемся нажать на какую-то из точек, но появляется пустое окошечко и ошибка в консоли при последующих кликах, говорящая, что "e is null". Пытаемся рассмотреть в документации кучу информации
про метод open у баллуна, но после просмотра кучи страниц доки ничего, что могло бы помочь, не находим.
Решаем узнать, на каком моменте происходит краш при открытии баллуна. Так как дебагер подключать
лень, используем console.log() :). После установления "брейкпоинтов" консол-логами выясняем, что
в самом обработчике кликов ошибок никаких не возникает, поэтому нужно копать в то, как устроен
сам баллун. В файле details.js есть разметка и пара методов. Пытаемся задебажить код логами и выясняем, что краш происходит после вызова BalloonContentLayout.superclass.build.call(this).
Это может происходить по нескольким причинам: либо ошибка в исходном коде (что вряд ли),
либо из-за стрелочных функций в объявлении метода. Так как call(this) присваивает контекст, и
стрелочные функции уже сами по себе сохраняют контекст, то ошибку можно решить либо убрав
call(this), либо заменив стрелочные функции на обычные. Второе решение почему-то проблему не решило,
но вот первое сработало на ура.

5. Открыв содержимое баллуна, видим, что графики не рисуются. Нужно глянуть файл chart.js.
Первое, что приходит в голову - посмотреть, доходят ли вообще данные до самой функции с графиком.
После несложных махинаций узнаём, что всё-таки доходят. Пытаемся узнать, добавляется ли
вообще график в контейнер. Добавляется :(, значит проблема в чём-то другом. Открываем документацию
chart.js и в бешенстве тыкаем по разным разделам и небрежно проскролливаем их вниз, так как
мы уже устали). Закрываем документацию и резко обнаруживаем параметр max у оси У графика, равный
нулю. По совету интуиции, убираем этот параметр и о чудо! Оно работает!

6. Теперь нужно сделать так, чтобы кластеры показывали, если в них есть неисправные объекты. Зайдём на страницу руководства для разработчиков, раздел объектов на карте. Проскроллив вниз, натыкаемся на кластеры, где есть возможность отобразить clusterIconLayout графиком, показывающим наличие в кластере объектов с разными цветами. Думаю, это подойдёт для поставленной задачи. Копипастим из документации строчку: clusterIconLayout: 'default#pieChart' и вуаля! Оно отображает то, что надо.

7. Во время работы над заданием обнаруживаем, что файл popup.js вообще никак не используется.
Проверяем, так ли оно на самом деле: просматриваем все используемые файлы на предмет импортов этого
файла, но ничего не находим. Чтобы удостовериться в высшей степени, просто удаляем этот файл и
смотрим, будет ли оно работать. В итоге всё работает прекрасно, а мы теперь соответствуем ещё одному критерию задания :).